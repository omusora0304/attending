import{t as c,e as re,b as d,s as q,c as le,h as be}from"../chunks/CKQCreVm.js";import{i as oe}from"../chunks/Bm3K0hjP.js";import{y as ie,A as de,a9 as ce,C as v,j as e,r as C,F as r,E as h,B as $,D as ve,v as i,ae as ge,z as ue,d as te,$ as pe}from"../chunks/BVNNn7ox.js";import{i as w,a as he,s as ye}from"../chunks/BqwgYQ-J.js";import{s as ne,e as qe,i as we,a as xe}from"../chunks/BPY4y56w.js";import{s as ze}from"../chunks/b1eVWlSn.js";import{t as Se,j as Ie,k as Me,m as Re,G as ke}from"../chunks/B9mEG7mM.js";import{s as Ce}from"../chunks/3iK5RE0Y.js";import{p as U}from"../chunks/DUUr3DC5.js";import{a as $e,g as De}from"../chunks/CWxlb6Ip.js";/* empty css                */import{f as ae,j as se}from"../chunks/DRTtKfAx.js";const He=()=>{const S=ze;return{page:{subscribe:S.page.subscribe},navigating:{subscribe:S.navigating.subscribe},updated:S.updated}},Le={subscribe(S){return He().page.subscribe(S)}};var je=c('<span class="processing svelte-fvnd3f">処理中...</span>'),Ee=c('<span class="countdown svelte-fvnd3f"> </span>'),Fe=c('<div class="error-message svelte-fvnd3f"> </div>'),Be=c("<button><!></button> <!>",1);function Ae(S,I){ie(I,!1);let E=U(I,"memberId",8),x=U(I,"status",8),T=U(I,"size",8,"normal"),g=C(!1),s=C(""),z=C(0),u;de(()=>{u&&clearInterval(u)});const y=async()=>{if(!e(g)){i(g,!0),i(s,"");try{console.log("処理開始: memberId=",E(),"current status=",x());const o=x()==="in"?"out":"in";console.log("記録追加中..."),await $e(E(),o),console.log("状態更新中..."),await Se(E(),x()),console.log("処理完了"),i(z,3),u=window.setInterval(()=>{ge(z,-1),e(z)<=0&&(clearInterval(u),window.location.hash="/")},1e3)}catch(o){console.error("状態変更失敗:",o),i(s,o.message||"状態の変更に失敗しました。しばらく待ってから再度お試しください。"),alert(e(s))}finally{i(g,!1)}}};oe();var f=Be(),M=ce(f),F=v(M);{var V=o=>{var _=je();d(o,_)},B=(o,_)=>{{var A=p=>{var R=Ee(),t=v(R);r(R),$(()=>q(t,`${x()==="in"?"入室":"退室"}しました。${e(z)??""}秒後にメインページに戻ります`)),d(p,R)},k=(p,R)=>{{var t=n=>{var D=le("退室する");d(n,D)},a=n=>{var D=le("入室する");d(n,D)};w(p,n=>{x()==="in"?n(t):n(a,!1)},R)}};w(o,p=>{e(z)>0?p(A):p(k,!1)},_)}};w(F,o=>{e(g)?o(V):o(B,!1)})}r(M);var j=h(M,2);{var m=o=>{var _=Fe(),A=v(_,!0);r(_),$(()=>q(A,e(s))),d(o,_)};w(j,o=>{e(s)&&o(m)})}$(()=>{ne(M,1,`status-button ${x()??""} ${T()??""} ${e(z)>0?"countdown":""}`,"svelte-fvnd3f"),Ce(M,"aria-label",`${x()==="in"?"退室":"入室"}する`),M.disabled=e(g)}),re("click",M,y),d(S,f),ve()}var Ge=c('<div class="loading svelte-qrz0oe">読み込み中...</div>'),Oe=c('<div class="error svelte-qrz0oe"> </div>'),Pe=c('<div class="empty svelte-qrz0oe">履歴がありません</div>'),Te=c('<div class="duration svelte-qrz0oe"> </div>'),Ve=c('<div><div class="record-type svelte-qrz0oe"> </div> <div class="record-time svelte-qrz0oe"><div class="date svelte-qrz0oe"> </div> <div class="time svelte-qrz0oe"> </div></div> <!></div>'),Je=c('<div class="history-list svelte-qrz0oe"></div>'),Ke=c('<div class="history-container svelte-qrz0oe"><h3 class="svelte-qrz0oe"> </h3> <!> <button class="refresh-button svelte-qrz0oe">更新する</button></div>');function Ne(S,I){ie(I,!1);let E=U(I,"memberId",8),x=U(I,"days",8,7),T=C([]),g=C(!0),s=C("");const z=m=>{const o=Math.floor(m/60),_=m%60;return o>0?`${o}時間${_>0?` ${_}分`:""}`:`${_}分`},u=async()=>{try{i(g,!0),i(T,await De(E(),x()))}catch(m){console.error("Failed to load records:",m),i(s,"履歴の読み込みに失敗しました")}finally{i(g,!1)}};ue(()=>{u()}),oe();var y=Ke(),f=v(y),M=v(f);r(f);var F=h(f,2);{var V=m=>{var o=Ge();d(m,o)},B=(m,o)=>{{var _=k=>{var p=Oe(),R=v(p,!0);r(p),$(()=>q(R,e(s))),d(k,p)},A=(k,p)=>{{var R=a=>{var n=Pe();d(a,n)},t=a=>{var n=Je();qe(n,5,()=>e(T),we,(D,l)=>{var b=Ve(),H=v(b),K=v(H,!0);r(H);var G=h(H,2),O=v(G),N=v(O,!0);r(O);var W=h(O,2),J=v(W,!0);r(W),r(G);var Y=h(G,2);{var Q=P=>{var L=Te(),X=v(L);r(L),$(Z=>q(X,`滞在時間: ${Z??""}`),[()=>z(e(l).duration)],te),d(P,L)};w(Y,P=>{e(l).type==="out"&&e(l).duration&&P(Q)})}r(b),$((P,L)=>{ne(b,1,`history-item ${e(l).type??""}`,"svelte-qrz0oe"),q(K,e(l).type==="in"?"入室":"退室"),q(N,P),q(J,L)},[()=>ae(e(l).timestamp,"yyyy年MM月dd日",{locale:se}),()=>ae(e(l).timestamp,"HH:mm",{locale:se})],te),d(D,b)}),r(n),d(a,n)};w(k,a=>{e(T).length===0?a(R):a(t,!1)},p)}};w(m,k=>{e(s)?k(_):k(A,!1)},o)}};w(F,m=>{e(g)?m(V):m(B,!1)})}var j=h(F,2);r(y),$(()=>{q(M,`最近の履歴 (直近${x()??""}日間)`),j.disabled=e(g)}),re("click",j,u),d(S,y),ve()}var Qe=c('<span class="status connected svelte-t9wq85">リアルタイム監視中</span>'),Ue=c('<span class="status connecting svelte-t9wq85">接続中...</span>'),We=c('<span class="status disconnected svelte-t9wq85">未接続</span> <button class="reconnect-button svelte-t9wq85">再接続</button>',1),Xe=c('<div class="loading svelte-t9wq85">読み込み中...</div>'),Ye=c('<div class="error svelte-t9wq85"> </div>'),Ze=c('<div class="member-card svelte-t9wq85"><div class="member-header svelte-t9wq85"><h1 class="member-name svelte-t9wq85"> </h1> <div class="grade-badge svelte-t9wq85"> </div> <div> </div></div> <div class="member-info svelte-t9wq85"><p class="status-time svelte-t9wq85"> </p></div> <div class="action-container svelte-t9wq85"><!></div> <!></div>'),et=c('<div class="member-page svelte-t9wq85"><div class="header-actions svelte-t9wq85"><a href="/#" class="back-link svelte-t9wq85">← トップに戻る</a> <div class="connection-info svelte-t9wq85"><!></div></div> <!></div>');function mt(S,I){ie(I,!1);const[E,x]=ye(),g=he(Le,"$page",E).params.id;let s=C(null),z=C(!0),u=C(""),y=null,f=C("disconnected");const M=async()=>{try{if(i(z,!0),i(u,""),i(s,await Ie(g)),!e(s)){i(u,"メンバーが見つかりません");return}F()}catch(t){console.error("Failed to load member:",t),i(u,"メンバー情報の読み込みに失敗しました")}finally{i(z,!1)}},F=()=>{try{y&&(y(),y=null),i(f,"connecting"),console.log("Setting up realtime listener for member:",g);const t=Me(g);y=Re(t,a=>{if(a.exists()){const n=a.data();i(s,{id:a.id,name:n.name,grade:n.grade||"B4",status:n.status,lastStatusChange:n.lastStatusChange?n.lastStatusChange.toDate():new Date}),console.log("Member updated via realtime:",e(s)),i(f,"connected")}else i(u,"メンバーが見つかりません（削除された可能性があります）"),i(f,"disconnected")},a=>{console.error("Realtime listener error:",a),i(u,`リアルタイム監視中にエラーが発生しました: ${a.message}`),i(f,"disconnected")})}catch(t){console.error("Failed to setup realtime listener:",t),i(u,"リアルタイム監視のセットアップに失敗しました"),i(f,"disconnected")}},V=()=>{F()};ue(()=>{M();const t=()=>{document.visibilityState==="visible"&&e(f)==="disconnected"&&V()};return document.addEventListener("visibilitychange",t),()=>{document.removeEventListener("visibilitychange",t)}}),de(()=>{y&&(y(),y=null)}),oe();var B=et();be(t=>{$(()=>{var a;return pe.title=`${((a=e(s))==null?void 0:a.name)??"メンバー"??""} | 滞在管理システム`})});var j=v(B),m=h(v(j),2),o=v(m);{var _=t=>{var a=Qe();d(t,a)},A=(t,a)=>{{var n=l=>{var b=Ue();d(l,b)},D=l=>{var b=We(),H=h(ce(b),2);re("click",H,V),d(l,b)};w(t,l=>{e(f)==="connecting"?l(n):l(D,!1)},a)}};w(o,t=>{e(f)==="connected"?t(_):t(A,!1)})}r(m),r(j);var k=h(j,2);{var p=t=>{var a=Xe();d(t,a)},R=(t,a)=>{{var n=l=>{var b=Ye(),H=v(b,!0);r(b),$(()=>q(H,e(u))),d(l,b)},D=(l,b)=>{{var H=K=>{var G=Ze(),O=v(G),N=v(O),W=v(N,!0);r(N);var J=h(N,2),Y=v(J,!0);r(J);var Q=h(J,2),P=v(Q,!0);r(Q),r(O);var L=h(O,2),X=v(L),Z=v(X);r(X),r(L);var ee=h(L,2),me=v(ee);Ae(me,{get memberId(){return e(s).id},get status(){return e(s).status},size:"large"}),r(ee);var fe=h(ee,2);Ne(fe,{get memberId(){return e(s).id}}),r(G),$(_e=>{q(W,e(s).name),xe(J,`background-color: ${ke[e(s).grade]??""}`),q(Y,e(s).grade),ne(Q,1,`status-badge ${e(s).status??""}`,"svelte-t9wq85"),q(P,e(s).status==="in"?"入室中":"退室中"),q(Z,`最終ステータス変更: ${_e??""}`)},[()=>ae(e(s).lastStatusChange,"yyyy年MM月dd日 HH:mm",{locale:se})],te),d(K,G)};w(l,K=>{e(s)&&K(H)},b)}};w(t,l=>{e(u)?l(n):l(D,!1)},a)}};w(k,t=>{e(z)?t(p):t(R,!1)})}r(B),d(S,B),ve(),x()}export{mt as component};
